var $jscomp=$jscomp||{};$jscomp.scope={};$jscomp.ASSUME_ES5=!1;$jscomp.ASSUME_NO_NATIVE_MAP=!1;$jscomp.ASSUME_NO_NATIVE_SET=!1;$jscomp.SIMPLE_FROUND_POLYFILL=!1;$jscomp.objectCreate=$jscomp.ASSUME_ES5||"function"==typeof Object.create?Object.create:function(a){var b=function(){};b.prototype=a;return new b};$jscomp.underscoreProtoCanBeSet=function(){var a={a:!0},b={};try{return b.__proto__=a,b.a}catch(c){}return!1};
$jscomp.setPrototypeOf="function"==typeof Object.setPrototypeOf?Object.setPrototypeOf:$jscomp.underscoreProtoCanBeSet()?function(a,b){a.__proto__=b;if(a.__proto__!==b)throw new TypeError(a+" is not extensible");return a}:null;
$jscomp.inherits=function(a,b){a.prototype=$jscomp.objectCreate(b.prototype);a.prototype.constructor=a;if($jscomp.setPrototypeOf){var c=$jscomp.setPrototypeOf;c(a,b)}else for(c in b)if("prototype"!=c)if(Object.defineProperties){var d=Object.getOwnPropertyDescriptor(b,c);d&&Object.defineProperty(a,c,d)}else a[c]=b[c];a.superClass_=b.prototype};$jscomp.getGlobal=function(a){return"undefined"!=typeof window&&window===a?a:"undefined"!=typeof global&&null!=global?global:a};$jscomp.global=$jscomp.getGlobal(this);
$jscomp.arrayIteratorImpl=function(a){var b=0;return function(){return b<a.length?{done:!1,value:a[b++]}:{done:!0}}};$jscomp.arrayIterator=function(a){return{next:$jscomp.arrayIteratorImpl(a)}};$jscomp.makeIterator=function(a){var b="undefined"!=typeof Symbol&&Symbol.iterator&&a[Symbol.iterator];return b?b.call(a):$jscomp.arrayIterator(a)};
$jscomp.defineProperty=$jscomp.ASSUME_ES5||"function"==typeof Object.defineProperties?Object.defineProperty:function(a,b,c){a!=Array.prototype&&a!=Object.prototype&&(a[b]=c.value)};$jscomp.polyfill=function(a,b,c,d){if(b){c=$jscomp.global;a=a.split(".");for(d=0;d<a.length-1;d++){var e=a[d];e in c||(c[e]={});c=c[e]}a=a[a.length-1];d=c[a];b=b(d);b!=d&&null!=b&&$jscomp.defineProperty(c,a,{configurable:!0,writable:!0,value:b})}};$jscomp.FORCE_POLYFILL_PROMISE=!1;
$jscomp.polyfill("Promise",function(a){function b(){this.batch_=null}function c(a){return a instanceof e?a:new e(function(b,c){b(a)})}if(a&&!$jscomp.FORCE_POLYFILL_PROMISE)return a;b.prototype.asyncExecute=function(a){if(null==this.batch_){this.batch_=[];var b=this;this.asyncExecuteFunction(function(){b.executeBatch_()})}this.batch_.push(a)};var d=$jscomp.global.setTimeout;b.prototype.asyncExecuteFunction=function(a){d(a,0)};b.prototype.executeBatch_=function(){for(;this.batch_&&this.batch_.length;){var a=
this.batch_;this.batch_=[];for(var b=0;b<a.length;++b){var c=a[b];a[b]=null;try{c()}catch(l){this.asyncThrow_(l)}}}this.batch_=null};b.prototype.asyncThrow_=function(a){this.asyncExecuteFunction(function(){throw a;})};var e=function(a){this.state_=0;this.result_=void 0;this.onSettledCallbacks_=[];var b=this.createResolveAndReject_();try{a(b.resolve,b.reject)}catch(h){b.reject(h)}};e.prototype.createResolveAndReject_=function(){function a(a){return function(d){c||(c=!0,a.call(b,d))}}var b=this,c=!1;
return{resolve:a(this.resolveTo_),reject:a(this.reject_)}};e.prototype.resolveTo_=function(a){if(a===this)this.reject_(new TypeError("A Promise cannot resolve to itself"));else if(a instanceof e)this.settleSameAsPromise_(a);else{a:switch(typeof a){case "object":var b=null!=a;break a;case "function":b=!0;break a;default:b=!1}b?this.resolveToNonPromiseObj_(a):this.fulfill_(a)}};e.prototype.resolveToNonPromiseObj_=function(a){var b=void 0;try{b=a.then}catch(h){this.reject_(h);return}"function"==typeof b?
this.settleSameAsThenable_(b,a):this.fulfill_(a)};e.prototype.reject_=function(a){this.settle_(2,a)};e.prototype.fulfill_=function(a){this.settle_(1,a)};e.prototype.settle_=function(a,b){if(0!=this.state_)throw Error("Cannot settle("+a+", "+b+"): Promise already settled in state"+this.state_);this.state_=a;this.result_=b;this.executeOnSettledCallbacks_()};e.prototype.executeOnSettledCallbacks_=function(){if(null!=this.onSettledCallbacks_){for(var a=0;a<this.onSettledCallbacks_.length;++a)g.asyncExecute(this.onSettledCallbacks_[a]);
this.onSettledCallbacks_=null}};var g=new b;e.prototype.settleSameAsPromise_=function(a){var b=this.createResolveAndReject_();a.callWhenSettled_(b.resolve,b.reject)};e.prototype.settleSameAsThenable_=function(a,b){var c=this.createResolveAndReject_();try{a.call(b,c.resolve,c.reject)}catch(l){c.reject(l)}};e.prototype.then=function(a,b){function c(a,b){return"function"==typeof a?function(b){try{d(a(b))}catch(r){f(r)}}:b}var d,f,g=new e(function(a,b){d=a;f=b});this.callWhenSettled_(c(a,d),c(b,f));return g};
e.prototype.catch=function(a){return this.then(void 0,a)};e.prototype.callWhenSettled_=function(a,b){function c(){switch(d.state_){case 1:a(d.result_);break;case 2:b(d.result_);break;default:throw Error("Unexpected state: "+d.state_);}}var d=this;null==this.onSettledCallbacks_?g.asyncExecute(c):this.onSettledCallbacks_.push(c)};e.resolve=c;e.reject=function(a){return new e(function(b,c){c(a)})};e.race=function(a){return new e(function(b,d){for(var e=$jscomp.makeIterator(a),f=e.next();!f.done;f=e.next())c(f.value).callWhenSettled_(b,
d)})};e.all=function(a){var b=$jscomp.makeIterator(a),d=b.next();return d.done?c([]):new e(function(a,e){function f(b){return function(c){g[b]=c;h--;0==h&&a(g)}}var g=[],h=0;do g.push(void 0),h++,c(d.value).callWhenSettled_(f(g.length-1),e),d=b.next();while(!d.done)})};return e},"es6","es3");
$jscomp.polyfill("Array.prototype.fill",function(a){return a?a:function(a,c,d){var b=this.length||0;0>c&&(c=Math.max(0,b+c));if(null==d||d>b)d=b;d=Number(d);0>d&&(d=Math.max(0,b+d));for(c=Number(c||0);c<d;c++)this[c]=a;return this}},"es6","es3");$jscomp.owns=function(a,b){return Object.prototype.hasOwnProperty.call(a,b)};$jscomp.assign="function"==typeof Object.assign?Object.assign:function(a,b){for(var c=1;c<arguments.length;c++){var d=arguments[c];if(d)for(var e in d)$jscomp.owns(d,e)&&(a[e]=d[e])}return a};
$jscomp.polyfill("Object.assign",function(a){return a||$jscomp.assign},"es6","es3");$jscomp.polyfill("Number.MAX_SAFE_INTEGER",function(){return 9007199254740991},"es6","es3");$jscomp.SYMBOL_PREFIX="jscomp_symbol_";$jscomp.initSymbol=function(){$jscomp.initSymbol=function(){};$jscomp.global.Symbol||($jscomp.global.Symbol=$jscomp.Symbol)};$jscomp.SymbolClass=function(a,b){this.$jscomp$symbol$id_=a;$jscomp.defineProperty(this,"description",{configurable:!0,writable:!0,value:b})};
$jscomp.SymbolClass.prototype.toString=function(){return this.$jscomp$symbol$id_};$jscomp.Symbol=function(){function a(c){if(this instanceof a)throw new TypeError("Symbol is not a constructor");return new $jscomp.SymbolClass($jscomp.SYMBOL_PREFIX+(c||"")+"_"+b++,c)}var b=0;return a}();
$jscomp.initSymbolIterator=function(){$jscomp.initSymbol();var a=$jscomp.global.Symbol.iterator;a||(a=$jscomp.global.Symbol.iterator=$jscomp.global.Symbol("Symbol.iterator"));"function"!=typeof Array.prototype[a]&&$jscomp.defineProperty(Array.prototype,a,{configurable:!0,writable:!0,value:function(){return $jscomp.iteratorPrototype($jscomp.arrayIteratorImpl(this))}});$jscomp.initSymbolIterator=function(){}};
$jscomp.initSymbolAsyncIterator=function(){$jscomp.initSymbol();var a=$jscomp.global.Symbol.asyncIterator;a||(a=$jscomp.global.Symbol.asyncIterator=$jscomp.global.Symbol("Symbol.asyncIterator"));$jscomp.initSymbolAsyncIterator=function(){}};$jscomp.iteratorPrototype=function(a){$jscomp.initSymbolIterator();a={next:a};a[$jscomp.global.Symbol.iterator]=function(){return this};return a};
$jscomp.iteratorFromArray=function(a,b){$jscomp.initSymbolIterator();a instanceof String&&(a+="");var c=0,d={next:function(){if(c<a.length){var e=c++;return{value:b(e,a[e]),done:!1}}d.next=function(){return{done:!0,value:void 0}};return d.next()}};d[Symbol.iterator]=function(){return d};return d};$jscomp.polyfill("Array.prototype.keys",function(a){return a?a:function(){return $jscomp.iteratorFromArray(this,function(a){return a})}},"es6","es3");
$jscomp.checkStringArgs=function(a,b,c){if(null==a)throw new TypeError("The 'this' value for String.prototype."+c+" must not be null or undefined");if(b instanceof RegExp)throw new TypeError("First argument to String.prototype."+c+" must not be a regular expression");return a+""};
$jscomp.polyfill("String.prototype.startsWith",function(a){return a?a:function(a,c){var b=$jscomp.checkStringArgs(this,a,"startsWith");a+="";var e=b.length,g=a.length;c=Math.max(0,Math.min(c|0,b.length));for(var f=0;f<g&&c<e;)if(b[c++]!=a[f++])return!1;return f>=g}},"es6","es3");var Repository=function(){this.loaded=this.max=0;this.dic={};this.reserved={};this.type="json"};Repository.prototype.isComplete=function(){return 0==this.max||0<this.max&&this.max==this.loaded};
Repository.prototype.reserve=function(a,b,c){null==a||0==a.length||a in this.reserved||(this.reserved[a]=!0,this.load(a,void 0===b?null:b,void 0===c?"":c))};Repository.prototype.makeName=function(a){return a};Repository.prototype.load=function(a,b,c){var d=this,e=new XMLHttpRequest;c=this.makeName(a);var g="json"==this.type;this.max++;e.open("GET",c,!0);g||(e.responseType=this.type);e.addEventListener("loadend",function(){var c=e.response;g&&(c=JSON.parse(c));d.onload(a,b,c)});e.send()};
Repository.prototype.onload=function(a,b,c){this.dic[a]=c;b&&(this.dic[b]=c);this.done()};Repository.prototype.done=function(){this.loaded++};Repository.prototype.checkLoading=function(a){var b=this;return new Promise(function(c){var d=function(){b.isComplete()?c():(a(),setTimeout(d,30))};d()})};var Matter=function(a,b,c){this.x=void 0===a?0:a;this.y=void 0===b?0:b;this.z=void 0===c?0:c;this.dy=0;this.dir=null;this.gravity=this.radian=0;this.speed=1};
Matter.prototype.setRect=function(a,b){this.width=a;this.hW=a/2;this.height=b;this.hH=b/2};Matter.prototype.move=function(){};
var Actor=function(a,b,c){Matter.call(this,void 0===a?0:a,void 0===b?0:b,void 0===c?0:c);this.region=new Region(this);this.setRect(16,16);this.animList=[];this.chamberList=[];this.hasBounds=!0;this.reaction=0;this.effectV=this.effectH=!1;this.hitPoint=1;this.activityAreaType=Actor.ActivityAreaType.FREEDOM;this.collidingWallType=Actor.CollidingWallType.THROUGH;this.absorbed=!1;this.absorbedTarget=null;this.score=0;this.isInverse=this.walled=!1;this.recalculation();this.fillStyle=null;this.sfx="sfx-explosion";
this.sfxAbsorb="sfx-absorb";this.enter()};$jscomp.inherits(Actor,Matter);Actor.prototype.recalculation=function(){var a=Product.Instance,b=this.hasBounds?0:a.width;this.minX=-this.width-b;this.minY=-this.height-b;this.maxX=a.width+this.width+b;this.maxY=a.height+this.height+b};Actor.prototype.checkInverse=function(){};Actor.prototype.enter=function(){this.explosion=0;this.isGone=!1};Actor.prototype.eject=function(){this.isGone=!0};
Actor.prototype.aim=function(a){if(a){var b=this.calcDistance(a);this.speed<b&&(this.dir=Math.atan2(a.y-this.y,a.x-this.x))}else this.dir=null;return this};Actor.prototype.closeGap=function(a){a=Math.trim(this.radian-Math.atan2(a.y-this.y,a.x-this.x));return Math.abs(a)<=Actor.DEG_STEP?0:0<a?-Actor.DEG_STEP:Actor.DEG_STEP};Actor.prototype.reactX=function(a){this.dir=Math.trim(this.dir+Math.PI)};Actor.prototype.reactY=function(a){this.y=a;this.dy*=-this.reaction;this.radian=this._stage.map.getHorizontalAngle(this)};
Actor.prototype.trigger=function(a,b){var c=this;b=void 0===b?!1:b;var d=[];this.chamberList.forEach(function(a){return a.probe()});null!=a&&a.isGone||!this.triggered&&!b||(this.triggered=!1,this.chamberList.forEach(function(b){(b=b.fire(c,a))&&d.push(b)}));return d};
Actor.prototype.checkActivityArea=function(){if(this._stage){var a=this.x-this._stage.map.x,b=this.y-this._stage.map.y,c=this._stage.map.x,d=this._stage.map.y;if(this.activityAreaType==Actor.ActivityAreaType.RESTRICTION)a=c+this.hW,b=c+Product.Instance.width-this.hW,c=d+this.hH,d=d+Product.Instance.height-this.hH,this.x<a?this.x=a:b<this.x&&(this.x=b),this._stage.scroll!=Stage.SCROLL.LOOP&&(this.y<c?this.y=c:d<this.y&&(this.y=d));else if(this.activityAreaType==Actor.ActivityAreaType.EJECT)(a<-this.width||
Product.Instance.width+this.width<a)&&this.eject(),this._stage.scroll!=Stage.SCROLL.LOOP&&(b<-this.height||Product.Instance.height+this.height<b)&&this.eject();else{d=2*Product.Instance.width;c=-Product.Instance.height;var e=2*Product.Instance.height;(a<-Product.Instance.width||d<a)&&this.eject();this._stage.scroll!=Stage.SCROLL.LOOP&&(b<c||e<b)&&this.eject()}}};
Actor.prototype.move=function(a){var b=this;if(0<this.explosion&&(this.explosion--,0==this.explosion)){this.eject();return}this.svX=this.x;this.svY=this.y;null!=this.dir&&(this.x+=Math.cos(this.dir)*this.speed,this.y+=Math.sin(this.dir)*this.speed);if(0!=this.gravity){var c=this._stage.map.scanFloor(this),d=!1;0>this.gravity?(c+=this.hH,c<this.y?this.dy+=this.gravity:this.y<c&&(d=!0)):(c-=this.hH,this.y<c?this.dy+=this.gravity:c<this.y&&(d=!0));d&&(2*this._stage.map.brickSize<Math.abs(this.y-c)?this.reactX(c):
this.reactY(c))}this.y+=this.dy*this.speed;this.animList.forEach(function(a){a.next(b.dir)});this.checkActivityArea();return this.trigger(a)};Actor.prototype.drawCircle=function(a){a.save();a.beginPath();a.fillStyle=this.fillStyle;a.arc(0,0,this.radius,0,2*Math.PI,!1);a.fill();a.restore()};Actor.prototype.drawHitPoint=function(a){1E5>this.hitPoint&&(a.save(),a.fillStyle="white",a.fillText(this.hitPoint,0,20),a.restore())};
Actor.prototype.drawNormal=function(a){this.animList.forEach(function(b){b.draw(a)});0==this.animList.length&&this.fillStyle&&this.drawCircle(a)};Actor.prototype.drawAbsorb=function(a){a.fillStyle="rgba(255, 200, 0, 0.4)";a.save();a.translate(this.absorbedTarget.x,this.absorbedTarget.y);a.beginPath();a.arc(0,0,5,0,Math.PI2);a.fill();a.restore();this.absorbedTarget=null};
Actor.prototype.drawExplosion=function(a){var b=this.explosion;a.save();a.fillStyle="rgba(255, 0, 0, 0.7)";a.beginPath();a.arc(0,0,b,0,Math.PI2,!1);a.fill();a.restore()};Actor.prototype.draw=function(a){this.isGone||(a.save(),a.translate(this.x,this.y),0<this.explosion?this.drawExplosion(a):this.drawNormal(a),a.restore(),this.absorbedTarget&&this.drawAbsorb(a))};
Actor.prototype.isHit=function(a){return this.isGone||0<this.explosion||0<a.explosion?!1:this.region.isHit(a.region)?(this.fate(a),a.fate(this),!0):!1};Actor.prototype.calcDistance=function(a){var b=this.x-a.x;a=this.y-a.y;return Math.sqrt(b*b+a*a)};
Actor.prototype.fate=function(a){a=void 0===a?null:a;null!=a&&a.isGone||this.isGone||this.explosion||(this.hitPoint--,0<this.hitPoint?this.absorb(a):(this.explosion=Actor.MAX_EXPLOSION,a=Product.Instance.calcPan(this),AudioMixer.INSTANCE.play(this.sfx,.2,!1,a)))};Actor.prototype.absorb=function(a){this.absorbed=!0;this.absorbedTarget=a;this.sfxAbsorb&&(a=Product.Instance.calcPan(this),AudioMixer.INSTANCE.play(this.sfxAbsorb,.3,!1,a))};
$jscomp.global.Object.defineProperties(Actor.prototype,{anim:{configurable:!0,enumerable:!0,set:function(a){var b=this;Array.isArray(a)?this.animList=a:this.animList=[a];var c=this.width,d=this.height;this.animList.forEach(function(a){a.actor=b;c=Math.max(c,a.width);d=Math.max(d,a.height)});this.setRect(c,d);this.recalculation()}}});Actor.MAX_EXPLOSION=12;Actor.DEG_STEP=Math.PI/180;Actor.Type={None:0,Ship:1,Shot:16,Missile:32,Capsule:48,Bullet:64,Material:80,Enemy:128,Formation:192,Boss:224};
Actor.TypeList="None Enemy Formation Boss Material Bullet Capsule Shot Missile Ship".split(" ");Actor.ActivityAreaType={FREEDOM:0,RESTRICTION:1,EJECT:2};Actor.CollidingWallType={THROUGH:0,SMASH:1,BOUNCE:2,EJECT:4,CRUSH:8,SMASH_CRUSH:9};var Animator=function(a,b,c,d){b=void 0===b?Animator.TYPE.ROTATION:b;c=void 0===c?1:c;d=void 0===d?1:d;Matter.call(this,0,0);this.type=b;this.numX=c;this.numY=d;this.patNum=0;this.setupImage(a)};$jscomp.inherits(Animator,Matter);
Animator.prototype.setupImage=function(a){this.img=VisualManager.Instance.dic[a];this.setRect(this.img.width/this.numX,this.img.height/this.numY)};
Animator.prototype.next=function(a){this.type&Animator.TYPE.V&&.1<Math.abs(this.patNum)&&(this.patNum=0>this.patNum?this.patNum+.1:this.patNum-.1);if(null!=a)if(this.type&Animator.TYPE.X)this.patNum+=.5*Math.cos(a),a=Math.floor(this.patNum),0>a?this.patNum=this.numX-.1:this.numX<=a&&(this.patNum=0);else if(this.type&Animator.TYPE.Y)this.patNum+=.5*Math.sin(a),a=Math.floor(this.patNum),0>a?this.patNum=this.numY-.1:this.numY<=a&&(this.patNum=0);else if(this.type&Animator.TYPE.V){var b=Math.floor(this.numY/
2);this.patNum+=Math.sin(a)/3;this.patNum<-b?this.patNum=-b:b<this.patNum&&(this.patNum=b)}this.patNum*=1E3;this.patNum=Math.round(this.patNum)/1E3};
Animator.prototype.draw=function(a){var b=this.actor,c=this.width,d=this.height,e=0,g=0;this.type&Animator.TYPE.X?e=c*Math.floor(this.patNum):this.type&Animator.TYPE.Y?g=d*Math.floor(this.patNum):this.type&Animator.TYPE.V&&(g=d*(parseInt(this.patNum)+(this.numY?parseInt(this.numY/2):0)));a.save();this.type==Animator.TYPE.NONE&&b.isInverse&&a.rotate(Math.PI);this.type&Animator.TYPE.ROTATION&&a.rotate(b.radian);b.scale&&a.scale(b.scale,b.scale);a.drawImage(this.img,e,g,c,d,-this.hW,-this.hH,c,d);a.restore()};
Animator.TYPE={NONE:0,ROTATION:1,X:2,Y:4,XY:6,H:8,V:16};var AudioMixer=function(){Repository.call(this);this.type="arraybuffer";this.ctx=null;if(window.AudioContext||window.webkitAudioContext)this.ctx=new (window.AudioContext||window.webkitAudioContext);this.dic=[];this.bgm=[];this.lastTime=this.lastKey=null};$jscomp.inherits(AudioMixer,Repository);
AudioMixer.prototype.makeName=function(a){var b=navigator.userAgent.toLowerCase(),c=36==a.length;return-1!==b.indexOf("edge")||-1!==b.indexOf("safari")?c?"/audio/audio/"+a:"/audio/audioName/"+a:c?"/audio/webm/"+a:"/audio/webmName/"+a};AudioMixer.prototype.onload=function(a,b,c){var d=this;null===this.ctx?this.done():this.ctx.decodeAudioData(c,function(c){d.dic[a]=c;b&&(d.dic[b]=c);d.done()})};
AudioMixer.prototype.play=function(a){if(null!==this.ctx&&this.dic[a]){var b=arguments.length,c=1<b?arguments[1]:1,d=2<b?arguments[2]:!1,e=3<b?arguments[3]:0;b=4<b?arguments[4]:0;var g=this.dic[a],f=new AudioElement(this.ctx,g,b);d&&(f.source.loopEnd=g.duration,f.source.loop=!0,this.bgm.push(f),this.lastKey=a);f.gainNode.gain.value=c;f.setPan(e);this.lastTime=this.ctx.currentTime-b}};AudioMixer.prototype.setPan=function(a){this.bgm.forEach(function(b){b.setPan(a)})};AudioMixer.prototype.fade=function(){this.bgm.forEach(function(a){a.fade()})};
AudioMixer.prototype.stop=function(){this.bgm.forEach(function(a){a.stop()})};AudioMixer.prototype.getCurrentTime=function(){if(0<this.bgm.length){var a=[];this.bgm.forEach(function(b){b.done||a.push(b)});this.bgm=a}return this.bgm.length?this.ctx.currentTime-this.lastTime:null};AudioMixer.prototype.setCurrentTime=function(a){this.bgm.length&&(this.stop(),this.play(this.lastKey,1,!0,0,a))};AudioMixer.INSTANCE=new AudioMixer;
function AudioElement(a,b,c){var d=this;this.done=!1;this.source=a.createBufferSource();this.gainNode=a.createGain();this.gainNode.connect(a.destination);"function"==typeof a.createStereoPanner?(this.panNode=a.createStereoPanner(),this.panNode.connect(this.gainNode),this.source.connect(this.panNode)):(this.panNode=null,this.source.connect(this.gainNode));this.source.buffer=b;this.source.start(0,c);this.source.onended=function(){d.done=!0}}
AudioElement.prototype.setPan=function(a){this.panNode&&(this.panNode.pan.value=a)};AudioElement.prototype.fade=function(){var a=this,b=this.gainNode.gain,c=b.value,d=function(){0==Math.floor(100*c)?a.stop():(c*=.9,b.value=c,setTimeout(d,600))};d()};AudioElement.prototype.stop=function(){this.done||this.source.stop()};
var Bricks=function(a){var b=this;this.bricks=null;if(a.map){var c=new Image;c.onload=function(){var a=document.createElement("canvas"),e=a.getContext("2d");a.width=c.width;a.height=c.height;e.drawImage(c,0,0);b.bricks=e.getImageData(0,0,c.width,c.height)};c.src=a.map}else this.reset(a);this.fieldMap=a};
Bricks.prototype.reset=function(a){var b=this;(new Promise(function(b){var c=function(){a._mainVisual.image?b(a._mainVisual.image):setTimeout(c,30)};c()})).then(function(c){var d=c.width/a.brickSize;c=c.height/a.brickSize;var e=d*c*4;b.bricks=new ImageData(d,c);b.bricks.data=Array(e)})};
Bricks.prototype.getIndex=function(a){if(!this.bricks)return-1;var b=this.fieldMap.brickSize,c=parseInt(a.x/b);b=parseInt(a.y/b);a._stage&&a._stage.isLoop&&(0>b&&(b+=this.bricks.height),this.bricks.height<b&&(b-=this.bricks.height));return 0>c||this.bricks.width<c||0>b||this.bricks.height<b?-1:4*(b*this.bricks.width+c)};Bricks.prototype.getBrick=function(a){a=this.getIndex(a);return-1==a?0:this.bricks.data[a+2]};
Bricks.prototype.putBrick=function(a,b){this.bricks.data[a+2]=b;this.bricks.data[a+3]=b?255:0};
Bricks.prototype.scanFloor=function(a){if(this.bricks){var b=this.fieldMap.brickSize,c,d=this.getBrick(a),e=0>a.gravity?-1:1;if(0<d){for(c=Math.floor(a.y/b)*b;0<d;)c-=b*e,d=this.getBrick({x:a.x,y:c});c+=b*e}else if(c=Math.floor(a.y/b)*b,0>e){for(;0<c&&!d;)c-=b,d=this.getBrick({x:a.x,y:c});d||(c=-a.height-b)}else{for(;c<a._stage.height&&!d;)c+=b,d=this.getBrick({x:a.x,y:c});d||(c=a._stage.height+a.height+b)}return c}};
Bricks.prototype.getHorizontalAngle=function(a){var b=this.fieldMap.brickSize,c=a.y-2*b,d=Object.assign({},a,{x:a.x-b,y:c});b=Object.assign({},a,{x:a.x+b,y:c});d=this.scanFloor(d);b=this.scanFloor(b);return Math.atan2(b-d,a.width)};
Bricks.prototype.isHit=function(a){if(!this.bricks)return!1;var b=this.getIndex(a);if(-1==b)return!1;var c=this.bricks.data[b+2];0<c&&(a.collidingWallType&Actor.CollidingWallType.EJECT&&a.eject(),a.collidingWallType&Actor.CollidingWallType.CRUSH&&a.fate());c==Bricks.BRICK_TYPE.BRITTLE&&a.collidingWallType&Actor.CollidingWallType.SMASH&&(this.bricks.data[b+2]=0,this.fieldMap._mainVisual.smash(a));return c};
Bricks.prototype.draw=function(a){var b=4*this.bricks.width,c=this.bricks.data,d=this.fieldMap.brickSize,e=.9*d,g=d/2,f=this.fieldMap.progress/this.fieldMap.scale-d;a.save();a.strokeStyle="rgba(255, 255, 255, .3)";a.fillStyle="rgba(0, 0, 0, .3)";for(var k=0;k<this.bricks.height;k++)for(var h=k*b,l=k*d,q=!0,p=0;p<b;p++,h+=4){var m=p*d,n=c[h+2];m<f||(q?(a.fillStyle="rgba(0, 0, 0, .8)",q=!1):a.fillStyle="rgba(0, 0, 0, .3)",n==Bricks.BRICK_TYPE.BRITTLE?(m+=g,n=l+g,a.beginPath(),a.arc(m,n,e/2,0,Math.PI2,
!1),a.fill(),a.stroke()):0<n&&(a.fillRect(m,l,e,e),a.strokeRect(m,l,e,e)))}a.restore()};Bricks.BRICK_TYPE={WALL:255,BRITTLE:254};var Bullet=function(a,b){Actor.call(this,a,b);this.region=new Region(this,2);this.radius=3;this.speed=2;this.anim=new Animator("bullet");this.activityAreaType=Actor.ActivityAreaType.EJECT;this.collidingWallType=Actor.CollidingWallType.EJECT;this.recalculation()};$jscomp.inherits(Bullet,Actor);Bullet.CollidingWallType=Actor.CollidingWallType;Bullet.ActivityAreaType=Actor.ActivityAreaType;
Bullet.TypeList=Actor.TypeList;Bullet.Type=Actor.Type;Bullet.DEG_STEP=Actor.DEG_STEP;Bullet.MAX_EXPLOSION=Actor.MAX_EXPLOSION;Bullet.prototype.move=function(a){Actor.prototype.move.call(this,a);this.radian+=Bullet.RAD_STEP};Bullet.RAD_STEP=Math.PI/180;var Capsule=function(a){Actor.call(this,a.x,a.y,-1);this.region=new Region(this,8);this.speed=0};$jscomp.inherits(Capsule,Actor);Capsule.CollidingWallType=Actor.CollidingWallType;Capsule.ActivityAreaType=Actor.ActivityAreaType;Capsule.TypeList=Actor.TypeList;
Capsule.Type=Actor.Type;Capsule.DEG_STEP=Actor.DEG_STEP;Capsule.MAX_EXPLOSION=Actor.MAX_EXPLOSION;Capsule.prototype.move=function(a){Actor.prototype.move.call(this,a);this.region.isHit(a.region)&&this.fate(a)};Capsule.RANGE=20;var Chamber=function(a,b,c,d){c=void 0===c?Number.MAX_SAFE_INTEGER:c;d=void 0===d?{}:d;this.type=a;this.cycle=b;this.max=c;this.opt=d;this.reset()};Chamber.prototype.reset=function(){this.tick=0;this.hands=[]};
Chamber.prototype.probe=function(){var a=[];this.hands.forEach(function(b){b.isGone||a.push(b)});this.hands=a;this.tick++};Chamber.prototype.fire=function(a,b){b=void 0===b?null:b;if(this.tick<this.cycle||this.max<=this.hands.length)return null;var c=new this.type(a.x,a.y,this.opt);if(b){var d=0;Product.Instance.stage.isMoving&&(d=a.calcDistance(b)/c.speed*Product.Instance.stage.fg.speed);c.dir=Math.atan2(b.y-a.y,b.x-a.x+d)}this.tick=0;this.hands.push(c);return c};
var Controller=function(a){this.keys={};this.point={};this.touch=!1;this.init(void 0===a?!1:a);Controller.Instance=this};Controller.prototype.init=function(a){a||window.addEventListener("contextmenu",function(a){a.preventDefault()});this.initKeys();this.initPointingDevice()};
Controller.prototype.initKeys=function(){var a=this;window.addEventListener("keydown",function(b){b.key?a.keys[b.key]=!0:a.keys["k"+b.keyCode]=!0});window.addEventListener("keyup",function(b){b.key?delete a.keys[b.key]:delete a.keys["k"+b.keyCode]})};
Controller.prototype.initPointingDevice=function(){var a=this,b=document.getElementById("canvas"),c=function(){a.touch=!1;a.point=null;a.prev=null;a.move=null;a.delta=null};b.addEventListener("mousedown",function(b){a.touch=!0;a.point=FlexibleView.Instance.convert(b.clientX,b.clientY);a.prev=a.point;a.move=a.point;a.delta={x:0,y:0}});b.addEventListener("mousemove",function(b){a.move=FlexibleView.Instance.convert(b.clientX,b.clientY);a.touch&&(a.point=a.move,a.delta={x:a.point.x-a.prev.x,y:a.point.y-
a.prev.y})});b.addEventListener("mouseup",function(){return c()});b.addEventListener("mouseleave",function(){return c()});b.addEventListener("touchstart",function(b){var c=b.touches[0];a.touch=!0;a.point=FlexibleView.Instance.convert(c.pageX,c.pageY);b.preventDefault()});b.addEventListener("touchmove",function(b){b=b.touches[0];a.touch=!0;a.point=FlexibleView.Instance.convert(b.pageX,b.pageY)});b.addEventListener("touchend",function(){return c()})};
Controller.prototype.decPoint=function(a,b){this.prev.x+=a;this.prev.y+=b};var Enemy=function(a,b,c){Actor.call(this,a,b,void 0===c?0:c);this.radian=Math.PI;this.routine=null;this.routineCnt=this.routineIx=0;this.chamberList=[new Chamber(Bullet,Enemy.TRIGGER_CYCLE)]};$jscomp.inherits(Enemy,Actor);Enemy.CollidingWallType=Actor.CollidingWallType;Enemy.ActivityAreaType=Actor.ActivityAreaType;Enemy.TypeList=Actor.TypeList;Enemy.Type=Actor.Type;Enemy.DEG_STEP=Actor.DEG_STEP;Enemy.MAX_EXPLOSION=Actor.MAX_EXPLOSION;
Enemy.prototype.checkInverse=function(){var a=Product.Instance.stage.map,b=Object.assign({},this,{y:this.y+this.hH+a.brickSize/2});this.isInverse=!a.bricks.isHit(b)};Enemy.prototype.move=function(a){this.routine&&this.routine[this.routineIx].tick(this,a);var b=Actor.prototype.move.call(this,a);!(a instanceof Enemy)&&this.calcDistance(a)<Enemy.TRIGGER_ALLOWANCE&&(b=[]);return b};Enemy.assign=function(a,b,c){a=Enemy.LIST[a%Enemy.LIST.length];if(!a)return null;a=Object.assign({},a);a.x=b;a.y=c;return a};
Enemy.TRIGGER_CYCLE=50;Enemy.TRIGGER_ALLOWANCE=100;Enemy.MAX_TYPE=127;Enemy.LIST=[];var Chain=function(a,b){Enemy.call(this,a,b);this.next=this.prev=null};$jscomp.inherits(Chain,Enemy);Chain.CollidingWallType=Enemy.CollidingWallType;Chain.ActivityAreaType=Enemy.ActivityAreaType;Chain.TypeList=Enemy.TypeList;Chain.Type=Enemy.Type;Chain.DEG_STEP=Enemy.DEG_STEP;Chain.MAX_EXPLOSION=Enemy.MAX_EXPLOSION;Chain.LIST=Enemy.LIST;Chain.MAX_TYPE=Enemy.MAX_TYPE;Chain.TRIGGER_ALLOWANCE=Enemy.TRIGGER_ALLOWANCE;
Chain.TRIGGER_CYCLE=Enemy.TRIGGER_CYCLE;Chain.assign=Enemy.assign;Chain.prototype.unshift=function(a){a.next=this;if(a.prev=this.prev)this.prev.next=a;this.prev=a;return this};Chain.prototype.push=function(a){a.prev=this;if(a.next=this.next)this.next.prev=a;this.next=a;return this};Chain.prototype.remove=function(){this.prev.next=this.next;this.next.prev=this.prev;return this.next};var Field=function(a){Matter.call(this);this.setRect(a.width,a.height);this.setupLandform(a);Field.Instance=this};
$jscomp.inherits(Field,Matter);Field.prototype.setupLandform=function(a){this.landform=new Landform(a.canvas)};Field.MAX_ENEMIES=100;Field.ENEMY_CYCLE=10;var FieldMap=function(){Matter.call(this);this.progressH=0;this._mainVisual=null};$jscomp.inherits(FieldMap,Matter);FieldMap.prototype.reset=function(){this.progressH=0;this.mapVisualList.forEach(function(a){return a.reset()});this.bricks=new Bricks(this)};FieldMap.prototype.scanFloor=function(a){return this.bricks.scanFloor(a)};
FieldMap.prototype.getHorizontalAngle=function(a){return this.bricks.getHorizontalAngle(a)};FieldMap.prototype.checkHit=function(a){a.walled=this.bricks.isHit(a)};FieldMap.prototype.setProgress=function(a){this.mapVisualList.forEach(function(b){return b.setProgress(a)})};
FieldMap.prototype.addProgressH=function(a){var b=this._stage;this.progressH+=a;if(b.scroll==Stage.SCROLL.ON){a=-this._mainVisual.image.height+Product.Instance.height;if(0<this.progressH)return this.progressH=0,!1;if(this.progressH<a)return this.progressH=a,!1}return!0};FieldMap.prototype.draw=function(a){this.mapVisualList.forEach(function(b){return b.draw(a)})};
FieldMap.prototype.migrate=function(){var a=this;if(!(0<this.mapVisualList.length)){console.log("FieldMap#migrate");var b=0;[{id:this.bg1,radian:this.bg1dir,speed:this.bg1speed,blink:this.bg1blink},{id:this.bg2,radian:this.bg2dir,speed:this.bg2speed,blink:this.bg2blink},{id:this.bg3,radian:this.bg3dir,speed:this.bg3speed,blink:this.bg3blink},{id:this.fg1,radian:this.fg1dir,speed:this.fg1speed,blink:this.fg1blink},{id:this.fg2,radian:this.fg2dir,speed:this.fg2speed,blink:this.fg2blink},{id:this.fg3,
radian:this.fg3dir,speed:this.fg3speed,blink:this.fg3blink}].forEach(function(c){if(null!=c.id&&0<c.id.length){var d=Mediaset.Instance.getVisual(c.id);c.id==a.fg1&&(a.mainSeq=b);a.mapVisualList.push(Object.assign(c,d,{seq:b++}))}});console.log("this.mapVisualList:"+this.mapVisualList.length);console.log("this.mainSeq:"+this.mainSeq)}};
FieldMap.prototype.init=function(){var a=this,b=[],c=0;this.migrate();this.mapVisualList.forEach(function(d,g){d.visualType==Visual.TYPE.Background&&c++;d._fieldMap=a;d.isMain=g==a.mainSeq;b.push(MapVisual.create(d))});this.mapVisualList=b;this._mainVisual=this.mapVisualList[this.mainSeq];var d=-1E4*(c-1)-1;this.mapVisualList.forEach(function(a){a.z=d;d+=1E4});this.reset();return this};
FieldMap.create=function(a){return"string"==typeof a?(new MapEntity).select(a).then(function(a){return FieldMap.create(a)}):Object.assign(new FieldMap,a).init()};$jscomp.global.Object.defineProperties(FieldMap.prototype,{x:{configurable:!0,enumerable:!0,get:function(){return-this._mainVisual.x}},y:{configurable:!0,enumerable:!0,get:function(){return-this._mainVisual.y}}});
var MapVisual=function(){Matter.call(this);this._imgName=this._img=null;this.isMain=!1;this.pattern=this.canvas=null;this.alpha=1;this.blinkDir=-1;this.effectV=this.effectH=0};$jscomp.inherits(MapVisual,Matter);MapVisual.prototype.reset=function(){this.pattern=this.canvas=null};
MapVisual.prototype.setProgress=function(a){var b=this.image.height,c=this._fieldMap._stage;this.x=a*Math.cos(this.radian)*this.speed;this.y=(a*Math.sin(this.radian)*this.speed+this._fieldMap.progressH)%b;c&&(c.scroll==Stage.SCROLL.LOOP&&0<this.y&&(this.y-=b),c.scroll==Stage.SCROLL.OFF|c.scroll==Stage.SCROLL.TOP&&0<this.y&&(this.y=0))};
MapVisual.prototype.getPattern=function(a){var b=this.image;null==this.canvas&&(this.canvas=document.createElement("canvas"),this.canvas.width=b.width,this.canvas.height=b.height,this.canvas.getContext("2d").drawImage(b,0,0));null==this.pattern&&(this.pattern=a.createPattern(this.canvas,"repeat"));return this.pattern};MapVisual.prototype.smash=function(a){var b=this.canvas.getContext("2d"),c=this._fieldMap.brickSize,d=parseInt(a.x/c)*c;a=parseInt(a.y/c)*c;b.clearRect(d,a,c,c);this.pattern=null};
MapVisual.prototype.draw=function(a){a.save();a.translate(this.x+this._fieldMap.x,this.y+this._fieldMap.y);a.globalAlpha=this.alpha;a.beginPath();a.fillStyle=this.getPattern(a);a.rect(-this.x,-this.y,a.canvas.width,a.canvas.height);a.fill();a.restore();this.blink&&(this.alpha+=this.blinkDir*this.blink,.3>=this.alpha||1<=this.alpha)&&(this.blinkDir*=-1)};
MapVisual.prototype.drawForDebug=function(a){var b=-this.x,c=10*this.seq;a.fillStyle="orange";a.beginPath();a.arc(b,c,5,0,Math.PI2);a.fill();a.fillStyle="pink";a.beginPath();a.arc(b+a.canvas.width,c,5,0,Math.PI2);a.fill()};MapVisual.create=function(a){return Object.assign(new MapVisual,a)};
$jscomp.global.Object.defineProperties(MapVisual.prototype,{image:{configurable:!0,enumerable:!0,get:function(){this._img||(this._img=Mediaset.Instance.getImage(this));return this._img}},imageName:{configurable:!0,enumerable:!0,get:function(){this._imgName||(this._imgName=Mediaset.Instance.getImageName(this));return this._imgName}}});
var FlexibleView=function(a,b){this.view=document.getElementById("view");this.canvas=document.getElementById("canvas");this.ctx=this.canvas.getContext("2d");this.scale=1;this.init();this.setSize(a,b);FlexibleView.Instance=this};FlexibleView.prototype.setSize=function(a,b){this.width=a;this.height=b;this.canvas.width=a;this.canvas.height=b;this.resize()};
FlexibleView.prototype.init=function(){var a=this,b=document.querySelector('[data-role="header"]'),c=document.querySelector('[data-role="footer"]');this.headerHeight=b?b.offsetHeight:0;this.footerHeight=c?c.offsetHeight:0;this.margin=this.headerHeight+this.footerHeight;window.addEventListener("resize",function(){a.resize()});window.addEventListener("keydown",function(){view.classList.contains("addicting")||view.classList.add("addicting")});window.addEventListener("mousemove",function(){view.classList.remove("addicting")})};
FlexibleView.prototype.resize=function(){var a=document.body.clientWidth/this.width,b=(window.innerHeight-this.margin)/this.height;this.scale=b<a?b:a;this.view.setAttribute("style",["width:"+this.width+"px","height:"+this.height+"px","transform: scale("+this.scale+")"].join(";"))};FlexibleView.prototype.convert=function(a,b){return{x:a/this.scale,y:(b-this.headerHeight)/this.scale}};FlexibleView.prototype.clear=function(){this.ctx.clearRect(0,0,this.width,this.height)};
var Formation=function(a,b){Actor.call(this,a,b);this.count=this.steps=0;this.enemies=[]};$jscomp.inherits(Formation,Actor);Formation.CollidingWallType=Actor.CollidingWallType;Formation.ActivityAreaType=Actor.ActivityAreaType;Formation.TypeList=Actor.TypeList;Formation.Type=Actor.Type;Formation.DEG_STEP=Actor.DEG_STEP;Formation.MAX_EXPLOSION=Actor.MAX_EXPLOSION;Formation.prototype.setup=function(a,b){for(var c=0;c<b;c++){var d=new a(this.x,this.y);this.bonus||(this.bonus=this.score=10*d.score);this.enemies.push(d)}return this};
Formation.prototype.isDestroyed=function(){var a=this,b=[];this.enemies.forEach(function(c){0!=c.hitPoint&&(b.push(c),a.x=c.x,a.y=c.y)});this.enemies=b;return 0==b.length&&0==this.explosion?(this.explosion=4*Actor.MAX_EXPLOSION,!0):!1};
Formation.prototype.move=function(a){Actor.prototype.move.call(this,a);this.isGone=0==this.enemies.filter(function(a){return!a.isGone}).length;if(this.enemies.length<=this.count){if(!this.isGone&&this.isDestroyed())return a=[SpeedupCapsule,MissileCapsule],[new (a[Math.floor(Math.random()*a.length)])(this)]}else if(0==this.steps++%Formation.STEP)return[this.enemies[this.count++]]};Formation.prototype.drawExplosion=function(a){a.fillStyle="rgba(240, 240, 255, .8)";a.fillText(this.bonus,0,0)};
Formation.STEP=10;var Landform=function(a){this.canvas=a;this.ctx=a.getContext("2d");this.effectH=0;this.next=Landform.NEXT.NONE;this.col=0;this.colDir=1;this.target=null;this.ty=this.tx=0;this.selection="b0";this.brickVal=this.brick=this.which=null;this.touch=!1;this.reverse=new Image;this.reverse.src="/img/reverse.png";this.touch=!1;this.scenarioList=[]};
Landform.prototype.loadStage=function(a){console.log("Landform#loadStage");var b=Field.Instance,c=a.fg.image;this.stage=a;a.mapData&&this.loadMapData(a.mapData);this.width=c.width;this.height=c.height;this.bw=this.width/Landform.BRICK_WIDTH;this.bh=this.height/Landform.BRICK_WIDTH;this.viewX=this.width-1.5*b.hW;this.arrivX=this.width-b.width;this.noticeX=this.arrivX-b.hW;this.reset()};
Landform.prototype.loadMapData=function(a){var b=this,c=new Image;c.onload=function(){var a=document.createElement("canvas"),e=a.getContext("2d");a.width=c.width;a.height=c.height;e.drawImage(c,0,0);b.brick=e.getImageData(0,0,c.width,c.height);b.loadScenario();b.touch=!0};c.src=a};Landform.prototype.loadScenario=function(){};Landform.prototype.reset=function(){this.next=Landform.NEXT.NONE;Product.Instance.stage&&Product.Instance.stage.reset()};
Landform.prototype.retry=function(){this.next=Landform.NEXT.NONE;Product.Instance.stage&&this.loadMapData(Product.Instance.stage.mapData)};Landform.prototype.getBrickIndex=function(a){var b=Product.Instance.stage.fg,c=Math.round((b.x+a.x-Landform.BRICK_HALF)/Landform.BRICK_WIDTH);if(0>c||this.bw<c)return-1;a=Math.round((b.y+a.y-Landform.BRICK_HALF)/Landform.BRICK_WIDTH);a%=this.bh;return a*this.bw*4+4*c};
Landform.prototype.getBrick=function(a,b){b=void 0===b?Landform.BRICK_LAYER.BRICK:b;if(!this.brick)return null;a=this.getBrickIndex(a);return 0>a?null:this.brick.data[a+b]};Landform.prototype.getAttr=function(a){return this.getBrick(a,Landform.BRICK_LAYER.ATTR)};Landform.prototype.getActor=function(a){return this.getBrick(a,Landform.BRICK_LAYER.ACTOR)};
Landform.prototype.putBrick=function(a,b,c){c=void 0===c?Landform.BRICK_LAYER.BRICK:c;a=this.getBrickIndex(a);0>a||(this.brick.data[a+c]=b,this.brick.data[a+3]=b?255:0)};$jscomp.global.Object.defineProperties(Landform.prototype,{mapImage:{configurable:!0,enumerable:!0,get:function(){var a=document.createElement("canvas"),b=a.getContext("2d");a.width=this.brick.width;a.height=this.brick.height;b.putImageData(this.brick,0,0);return a.toDataURL("image/png")}}});Landform.BRICK_WIDTH=8;
Landform.BRICK_HALF=Landform.BRICK_WIDTH/2;Landform.BRICK_LAYER={ATTR:0,ACTOR:1,BRICK:2};Landform.BRICK_TYPE={WALL:255,BRITTLE:254};Landform.ATTR={NONE:0,REVERSE:1};Landform.COL_MAX=512;Landform.NEXT={NONE:0,NOTICE:1,ARRIV:2,IDLE:3,PAST:4};
Landform.prototype.effect=function(a){var b=Math.max(Product.Instance.width+a.width,a.maxX);a.effectH&&(a.x-=this.effectH);a.effectV&&this.next==Landform.NEXT.NONE&&(a.y+=Product.Instance.stage.effectV*Product.Instance.stage.fg.speed);(a.x<a.minX||b<a.x)&&a.eject();Product.Instance.stage.scroll==Stage.SCROLL.OFF?(a.y<a.minY||a.maxY<a.y)&&a.eject():Product.Instance.stage.scroll==Stage.SCROLL.ON?(a.y<-this.height||this.height+a.maxY<a.y)&&a.eject():a.gravity&&Landform.BRICK_WIDTH+Landform.BRICK_HALF<
Math.abs(a.dy*a.speed)?a.eject():0>a.y?a.y+=this.height:this.height<a.y&&(a.y-=this.height)};
Landform.prototype.forward=function(a){var b=Product.Instance.stage.map;this.next!=Landform.NEXT.ARRIV&&Product.Instance.stage.scrollV(a);if(this.viewX<=b.x)return this.effectH=0,this.next!=Landform.NEXT.PAST?this.next=Landform.NEXT.PAST:Landform.NEXT.NONE;Product.Instance.stage.forward();if(this.arrivX<=b.x){if(this.next==Landform.NEXT.NOTICE)return this.effectH=0,this.next=Landform.NEXT.ARRIV;if(this.arrivX<b.x)return this.next=Landform.NEXT.IDLE}else if(this.noticeX<=b.x&&this.next!=Landform.NEXT.NOTICE)return this.next=
Landform.NEXT.NOTICE;return Landform.NEXT.NONE};Math.PI2=Math.PI2||2*Math.PI;Math.SQ=Math.SQ||Math.PI/2;Math.trim=Math.trim||function(a){for(;Math.PI<a;)a-=Math.PI2;for(;a<-Math.PI;)a+=Math.PI2;return a};Math.close=Math.close||function(a,b,c){b=Math.trim(a-b);return Math.abs(b)<=c?a:0<b?a-c:a+c};function Matrix(a){this.mat=a}Matrix.NO_EFFECT=[[1,0,0,0],[0,1,0,0],[0,0,1,0],[0,0,0,1]];
Matrix.rotateX=function(a){return new Matrix([[1,0,0,0],[0,Math.cos(a),-Math.sin(a),0],[0,Math.sin(a),Math.cos(a),0],[0,0,0,1]])};Matrix.rotateY=function(a){return new Matrix([[Math.cos(a),0,Math.sin(a),0],[0,1,0,0],[-Math.sin(a),0,Math.cos(a),0],[0,0,0,1]])};Matrix.rotateZ=function(a){return new Matrix([[Math.cos(a),-Math.sin(a),0,0],[Math.sin(a),Math.cos(a),0,0],[0,0,1,0],[0,0,0,1]])};
Matrix.prototype.multiply=function(a){var b=[[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0]],c=a.mat;this.mat.forEach(function(a,e){a.forEach(function(d,f){for(var g=d=0;4>g;g++)d+=a[g]*c[g][f];b[e][f]=d})});return new Matrix(b)};Matrix.prototype.affine=function(a,b,c){var d=this.mat;return{x:d[0][0]*a+d[0][1]*b+d[0][2]*c+d[0][3],y:d[1][0]*a+d[1][1]*b+d[1][2]*c+d[1][3],z:d[2][0]*a+d[2][1]*b+d[2][2]*c+d[2][3]}};var Mediaset=function(){this.audioDic={};this.visualDic={}};
Mediaset.prototype.loadAudio=function(){var a=this;this.audioList.forEach(function(b){a.audioDic[b.audioType+":"+b.audioSeq]=b;AudioMixer.INSTANCE.reserve(b.id,b.name)});return this};Mediaset.prototype.loadVisual=function(){var a=this;this.visualList.forEach(function(b){a.visualDic[b.visualType+":"+b.visualSeq]=b;VisualManager.Instance.reserve(b.id,b.name,b.contentType)});return this};Mediaset.prototype.load=function(){return this.loadAudio().loadVisual()};
Mediaset.prototype.checkLoading=function(a){var b=[VisualManager.Instance,AudioMixer.INSTANCE],c=b.reduce(function(a,b){return a.max+b.max}),d=function(){var d=b.reduce(function(a,b){return a.loaded+b.loaded});a(d,c)};return Promise.all([VisualManager.Instance.checkLoading(d),AudioMixer.INSTANCE.checkLoading(d)])};Mediaset.prototype.getVisual=function(a){var b=null;this.visualList.forEach(function(c){c.id==a&&(b=c)});return b};
Mediaset.prototype.getImage=function(a){return VisualManager.Instance.dic[this.visualDic[a.visualType+":"+a.visualSeq].id]};Mediaset.prototype.getImageName=function(a){return this.visualDic[a.visualType+":"+a.visualSeq].name};Mediaset.create=function(a){if("string"==typeof a)return(new MediasetEntity).select(a).then(function(a){return Mediaset.create(a)});Mediaset.Instance=Object.assign(new Mediaset,a);return Mediaset.Instance};Mediaset.Instance=null;var Visual=function(){};
Visual.TYPE={Player:0,Shot:1,Item:2,Aerial:3,Subaerial:4,Boss:5,Ornament:6,Explosion:7,Background:8,Foreground:9,Other:10};var Missile=function(a,b,c){Actor.call(this,a,b);this.dir=c.dir;this.radius=2;this.speed=3;this.gravity=c.gravity;this.activityAreaType=Actor.ActivityAreaType.EJECT;this.recalculation();this.shuttle=3;this.fillStyle="rgba(200, 200, 255, 0.6)"};$jscomp.inherits(Missile,Actor);Missile.CollidingWallType=Actor.CollidingWallType;Missile.ActivityAreaType=Actor.ActivityAreaType;
Missile.TypeList=Actor.TypeList;Missile.Type=Actor.Type;Missile.DEG_STEP=Actor.DEG_STEP;Missile.MAX_EXPLOSION=Actor.MAX_EXPLOSION;Missile.prototype.reactX=function(a){Actor.prototype.reactX.call(this,a);this.shuttle--;0>this.shuttle&&this.fate()};Missile.prototype.fate=function(){this.eject()};function Gizmo(a,b,c){this.type=a;this.destination=b;this.param=void 0===c?null:c}Gizmo.TYPE={FIXED:0,OWN:1,AIM:2,CHASE:3};Gizmo.DEST={TO:0,TO_X:1,TO_Y:2,ROTATE:3,ROTATE_L:4,ROTATE_R:5,LEFT:6,RIGHT:7};
Gizmo.prototype.tick=function(a,b){if(this.type==Gizmo.TYPE.FIXED)this.destination==Gizmo.DEST.ROTATE?a.radian=a.dir:a.dir=null;else if(this.type==Gizmo.TYPE.OWN)this.destination==Gizmo.DEST.ROTATE_L?a.dir-=a.step:this.destination==Gizmo.DEST.ROTATE_R?a.dir+=a.step:this.destination==Gizmo.DEST.LEFT?a.dir=Math.PI:this.destination==Gizmo.DEST.RIGHT&&(a.dir=0);else{var c=b.x-a.x,d=b.y-a.y;Math.abs(c)<=a.speed&&(c=0);Math.abs(d)<=a.speed&&(d=0);this.type==Gizmo.TYPE.AIM?this.destination==Gizmo.DEST.TO_X?
a.radian=0>c?Math.PI:0:this.destination==Gizmo.DEST.TO_Y?a.radian=0>c?-Math.SQ:Math.SQ:this.destination==Gizmo.DEST.ROTATE&&(b=a.calcDistance(b),a.speed<b&&(a.radian=Math.close(a.radian,Math.atan2(d,c),this.param?this.param:Math.PI/30),a.radian=Math.trim(a.radian))):this.type==Gizmo.TYPE.CHASE&&(this.destination==Gizmo.DEST.TO?a.dir=Math.atan2(d,c):this.destination==Gizmo.DEST.TO_X&&c?a.dir=Math.atan2(0,c):this.destination==Gizmo.DEST.TO_Y&&d?a.dir=Math.atan2(d,0):this.destination==Gizmo.DEST.ROTATE&&
(a.dir=Math.close(a.dir,Math.atan2(d,c),this.param?this.param:Math.PI/60),a.radian=a.dir))}};function Movement(a){var b=parseInt(a);this.cond=a;this.count=b==a?b:null;this.list=[]}Movement.COND={X:"x",Y:"y"};Movement.prototype.add=function(a,b,c){this.list.push(new Gizmo(a,b,c));return this};
Movement.prototype.isValid=function(a,b){if(this.cond){if(this.count){if(a.routineCnt++<this.count)return!0;a.routineCnt=0;return!1}var c=b.x-a.x;b=b.y-a.y;return this.cond==Movement.COND.X&&Math.abs(c)<=a.speed||this.cond==Movement.COND.Y&&Math.abs(b)<=a.speed?!1:!0}};Movement.prototype.tick=function(a,b){this.list.forEach(function(c){c.tick(a,b)});this.isValid(a,b)||(a.routineIx++,a.routine.length<=a.routineIx&&(a.routineIx=0))};
var Product=function(){Matter.call(this);this.maxShip=7;this.maxHibernate=60;this.stageNum=this.hiscore=this.score=this.shipRemain=0;this.stage=null;this.performersList=[]};$jscomp.inherits(Product,Matter);Product.prototype.calcPan=function(a){return(a.x-this.hW)/this.hW};Product.prototype.startGame=function(){this.increase();this.loosingRate=Product.MAX_LOOSING_RATE;this.score=0;this.shipRemain=this.maxShip;this.stageNum=0;this.nextStage();this._reset()};
Product.prototype.increase=function(){(new ProductEntity).increase(this.id).then(function(a){console.log("Product#increase:"+a.ok)})};
Product.prototype.nextStage=function(){var a=this;console.log("Product#nextStage:"+this.stageNum);this.ship&&console.log("ship_"+this.ship.x+"/"+this.ship.y);var b=this.detailList[this.stageNum];this.performersList=this.performersList.filter(function(a){return!(a instanceof MapVisual)});this.performersList.forEach(function(a){a.x-=a._stage.map.x;a.y-=a._stage.map.y});this.ship&&(console.log("map:"+this.stage.map.x+"/"+this.stage.map.y),console.log("ship:"+this.ship.x+"/"+this.ship.y));this.stage=
Object.assign(b);Field.Instance.landform.loadStage(this.stage);this.stageNum++;this.detailList.length<=this.stageNum&&(this.stageNum=0);this.performersList.forEach(function(b){b.x+=a.stage.map.x;b.y+=a.stage.map.y;b._stage=a.stage});this.stage.map.mapVisualList.forEach(function(b){return a.performersList.push(b)})};Product.prototype.selectStage=function(a){var b=this;this.detailList.forEach(function(c){c.id==a&&(b.stage=StageEditor.create(c))});this.stage.map.mapVisualList.forEach(function(a){return b.performersList.push(a)})};
Product.prototype._reset=function(){var a=this;this.ship=new Ship(-400,100);this.ship._stage=this.stage;this.ship.reset();this.ship.enter();this.performersList=[this.ship];this.stage.map.mapVisualList.forEach(function(b){return a.performersList.push(b)})};Product.prototype.retry=function(){Field.Instance.landform.retry();this.stage.retry();this._reset()};
Product.prototype.move=function(){var a=this;if(this.stage&&this.stage.phase!=Stage.PHASE.BOSS){this.stage.scanEvent().forEach(function(b){return a.performersList.push(b)});var b=Field.Instance.landform.forward(this.ship);this.isGameOver||(b==Landform.NEXT.NOTICE?(AudioMixer.INSTANCE.fade(),this.stage.notice()):b==Landform.NEXT.ARRIV?this.stage.toBossMode():b==Landform.NEXT.PAST&&this.nextStage(),Product.MIN_LOOSING_RATE<this.loosingRate&&(this.loosingRate-=this.loosingRate/1E4))}};
Product.prototype.draw=function(a){var b=this;if(this.stage){var c=this.performersList.filter(function(a){return a instanceof Ship}),d=0<c.length?c[0]:new Actor,e=[],g=[],f=[],k=0;this.performersList.sort(function(a,b){return a.z-b.z});this.performersList.forEach(function(a){if(!a.isGone){a instanceof Bullet?c.forEach(function(b){return a.isHit(b)}):a instanceof Enemy?g.push(a):(a instanceof Shot||a instanceof Missile)&&e.push(a);var h=a.move(d);h instanceof Array&&h.forEach(function(a){a._stage=
b.stage;f.push(a)});b.stage.effect(a);f.push(a);a.explosion&&a.score&&(k+=a.score,a.score=0)}});this.stage.effectMap(d);g.forEach(function(a){a.triggered=0==parseInt(Math.random()*b.loosingRate/10);c.forEach(function(b){return a.isHit(b)});e.forEach(function(b){return a.isHit(b)})});this.stage.phase==Stage.PHASE.BOSS&&0==g.length&&(this.stage.phase=Stage.PHASE.NORMAL,AudioMixer.INSTANCE.fade());this.performersList=f;this.score+=k;!this.isGameOver&&c.every(function(a){return a.isGone})&&(AudioMixer.INSTANCE.stop(),
0>=--this.stage.hibernate&&0<--this.shipRemain&&this.retry());a.save();a.translate(this.stage.fg.x,this.stage.fg.y);this.performersList.forEach(function(b){return b.draw(a)});this.stage.draw(a);a.restore();this.drawForDebug(a)}};
Product.prototype.drawForDebug=function(a){var b=20,c=this.performersList.filter(function(a){return!(a instanceof MapVisual)}),d=this.stage.map._mainVisual;a.save();a.strokeStyle="white";a.strokeText("actors:"+c.length+(0<c.length?"|"+c[c.length-1].constructor.name:""),2,b+=20);a.strokeText("progress:"+parseInt(this.stage.progress)+"/"+parseInt(d.progressH),2,b+=20);a.strokeText("map:"+parseInt(d.x)+"/"+d.y,2,b+=20);this.ship&&(c=parseInt(this.ship.x),d=parseInt(this.ship.y+d.y),a.strokeText("ship:"+
c+"/"+d,2,b+=20));a.restore()};Product.prototype.registerScore=function(){var a=new FormData;a.append("productId",this.id);a.append("score",this.score);a.append("name","");(new ScoreEntity).register(a).then(function(a){console.log("registerScore:"+a.ok)})};Product.prototype.init=function(){var a=this,b=[];this.setRect(this.width,this.height);this.detailList.forEach(function(c){c.product=a;b.push(Stage.create(c))});this.detailList=b;0<this.scoreList.length&&(this.hiscore=this.scoreList[0].score);return this};
Product.create=function(a){return(new ProductEntity).select(a).then(function(a){Mediaset.create(a.mediaset).load();Product.Instance=Object.assign(new Product,a);return Product.Instance.init()})};$jscomp.global.Object.defineProperties(Product.prototype,{isGameOver:{configurable:!0,enumerable:!0,get:function(){return 0>=this.shipRemain}}});Product.Instance=null;Product.MIN_LOOSING_RATE=1;Product.MAX_LOOSING_RATE=2E4;
var Region=function(a,b,c){b=void 0===b?Region.DefaultSize:b;c=void 0===c?Region.Type.CIRCLE:c;this.matter=a;this.size=b;this.type=c;this.width=2*b};Region.prototype.isHit=function(a){if(this.type==Region.Type.CIRCLE&&a.type==Region.Type.CIRCLE){var b=this.matter.x-a.matter.x,c=this.matter.y-a.matter.y;return Math.sqrt(b*b+c*c)<this.size+a.size}console.log("*Not implement*")};
Region.prototype.draw=function(a){a.save();a.strokeStyle="rgba(80, 255, 80, 0.6)";this.type==Region.Type.RECTANGLE?a.strokeRect(-this.size,-this.size,this.width,this.width):(a.beginPath(),a.arc(0,0,this.size,0,Math.PI2,!1),a.stroke());a.restore()};Region.DefaultSize=4;Region.Type={CIRCLE:1,RECTANGLE:2};var Ship=function(a,b){Actor.call(this,a,b);this.activityAreaType=Actor.ActivityAreaType.RESTRICTION;this.effectH=!0;this.anim=new Animator("prototype.ship",Animator.TYPE.V,1,2*Ship.PATTERNS+1);this.reset()};
$jscomp.inherits(Ship,Actor);Ship.CollidingWallType=Actor.CollidingWallType;Ship.ActivityAreaType=Actor.ActivityAreaType;Ship.TypeList=Actor.TypeList;Ship.Type=Actor.Type;Ship.DEG_STEP=Actor.DEG_STEP;Ship.MAX_EXPLOSION=Actor.MAX_EXPLOSION;Ship.prototype.recalculation=function(){var a=Product.Instance;Actor.prototype.recalculation.call(this);a&&(this.right=a.width-2*this.width,this.bottom=a.height-this.hH)};
Ship.prototype.reset=function(){this.speed=Ship.MIN_SPEED;this.triggered=!1;this.chamberList=[new Chamber(Shot,4,Ship.MAX_SHOTS)];this.chamberList.forEach(function(a){return a.reset()});this.missileLevel=0};Ship.prototype.speedup=function(){this.speed*=1.25;Ship.MAX_SPEED<this.speed&&(this.speed=Ship.MAX_SPEED)};
Ship.prototype.powerUpMissile=function(){this.missileLevel++;1==this.missileLevel?this.chamberList.push(new Chamber(Missile,16,2,{gravity:.05,dir:0})):2==this.missileLevel?this.chamberList.push(new Chamber(Missile,16,2,{gravity:-.05,dir:0})):3==this.missileLevel&&(this.chamberList.push(new Chamber(Missile,16,2,{gravity:.05,dir:Math.PI})),this.chamberList.push(new Chamber(Missile,16,2,{gravity:-.05,dir:Math.PI})))};
Ship.prototype.inkey=function(a){var b=!1,c=0;if(a.ArrowLeft||a.Left||a.k37)c=1,b=!0;else if(a.ArrowRight||a.Right||a.k39)c=-1,b=!0;if(a.ArrowUp||a.Up||a.k38)c=2-.5*c,b=!0;else if(a.ArrowDown||a.Down||a.k40)c*=.5,b=!0;b&&(this.dir=(c+1)*Math.SQ);if(a.Control||a.Shift||a.k16||a.k17)this.triggered=!0};
Ship.prototype.move=function(){this.dir=null;this.aim(Controller.Instance.point);this.inkey(Controller.Instance.keys);Controller.Instance.touch&&(this.triggered=!0);var a=Actor.prototype.move.call(this);if(!this.isGone)if(this.walled)this.fate();else return a};Ship.MIN_SPEED=1.5;Ship.MAX_SPEED=5;Ship.MAX_SHOTS=7;Ship.PATTERNS=2;
var Shot=function(a,b){Actor.call(this,a,b);this.dir=0;this.radius=2;this.speed=6;this.size=2;this.activityAreaType=Actor.ActivityAreaType.EJECT;this.collidingWallType=Actor.CollidingWallType.SMASH_CRUSH;this.fillStyle="rgba(255, 255, 0, 0.7)";a=Product.Instance.calcPan(this);AudioMixer.INSTANCE.play("sfx-fire",.4,!1,a)};$jscomp.inherits(Shot,Actor);Shot.CollidingWallType=Actor.CollidingWallType;Shot.ActivityAreaType=Actor.ActivityAreaType;Shot.TypeList=Actor.TypeList;Shot.Type=Actor.Type;
Shot.DEG_STEP=Actor.DEG_STEP;Shot.MAX_EXPLOSION=Actor.MAX_EXPLOSION;Shot.prototype.fate=function(){this.eject()};var Stage=function(){this.boss=this.bgm=this.foreground=null;this.checkPoint=Stage.CHECK_POINT[0];this.viewDic={};this.progress=this.effectV=this.effectH=0;this.eventList=[];this.lastScan=null};Stage.prototype.setBgm=function(a,b){this.bgm=a;this.boss=void 0===b?null:b;return this};Stage.prototype.playBgm=function(){this.bgm&&AudioMixer.INSTANCE.play(this.bgm,.7,!0)};
Stage.prototype.getGround=function(a){return this.viewDic[a]};Stage.prototype.reset=function(){this.checkPoint=Stage.CHECK_POINT[0];this.retry()};
Stage.prototype.retry=function(){var a=this;this.phase=Stage.PHASE.NORMAL;this.progress=-this.product.width/this.map._mainVisual.speed;this.hibernate=this.product.maxHibernate;this.scroll=this.scrollSv;this.effectV=this.effectH=0;this.map.reset();this.map.setProgress(this.progress);this.view.forEach(function(b){b.reset(a.checkPoint)});this.eventList=this.scenarioList.concat();this.playBgm()};
Stage.prototype.scrollV=function(a){this.effectV=0;if(this.scroll!=Stage.SCROLL.OFF){var b=this.product.hH-a.y;a=this.fg;if(this.scroll==Stage.SCROLL.TOP)b=5*a.speed;else if(this.scroll==Stage.SCROLL.BOTTOM)b=5*-a.speed;else if(Math.abs(b)<a.speed)return;b/=3;var c=a.y-b,d=a.image.height-this.product.height;if(this.scroll!=Stage.SCROLL.ON||!(0>c||d<c))if(this.scroll==Stage.SCROLL.TOP&&0>c)this.scroll=Stage.SCROLL.OFF;else{if(this.scroll==Stage.SCROLL.BOTTOM&&(console.log("nextY:"+c+"/"+a.image.height),
d<c)){this.scroll=Stage.SCROLL.OFF;return}this.effectV=b}}};Stage.prototype.effect=function(a){var b=this.map._mainVisual;if(!(a instanceof MapVisual)&&this.isMoving){if(this.isLoop){var c=b.y+a.y;0>c&&(a.y+=this.height);this.height<c&&(a.y-=this.height)}a.effectH&&(a.x-=Math.cos(b.radian)*b.speed);a.effectV&&(a.y-=Math.sin(b.radian)*b.speed);this.map.checkHit(a)}};
Stage.prototype.effectMap=function(a){var b=this.map._mainVisual,c=b.image.height;b=(a.y+b.y+c)%c;c=this.product.hH/2;var d=this.product.height-c;this.scroll&(Stage.SCROLL.ON|Stage.SCROLL.LOOP)&&(b<c&&this.map.addProgressH(a.speed)&&(a.y+=a.speed),d<b&&this.map.addProgressH(-a.speed)&&(a.y-=a.speed))};
Stage.prototype.scanEvent=function(){var a=this,b=[],c=-this.fg.x,d=Math.round(c/this.map.brickSize);if(d==this.lastScan)return b;var e=Math.round((c+this.product.width)/this.map.brickSize),g=[];this.eventList.forEach(function(f){var k=!1,h="spawn"==f.op;if(h){if(f.v<e)return;f.v==e&&(k=!0)}else if("reverse"==f.op){if(f.v<d)return;f.v==d&&(k=!0)}k?(f=Enemy.assign(f.number,c+(h?a.product.width+1.5*a.map.brickSize:0),(f.h+1)*a.map.brickSize),null!=f&&(f=f.formation?(new Formation(f.x,f.y)).setup(f.type,
8):new f.type(f.x,f.y),f._stage=a,b.push(f))):g.push(f)});this.eventList=g;this.lastScan=d;return b};Stage.prototype.forward=function(){var a=this;this.map.setProgress(this.progress++);var b=this.fg.x;Stage.CHECK_POINT.forEach(function(c){c.x<=b&&a.checkPoint.x<b&&(a.checkPoint=c)})};Stage.prototype.notice=function(){if(this.scroll==Stage.SCROLL.ON||this.scroll==Stage.SCROLL.LOOP){var a=this.fg;this.scroll=a.y<a.image.height/2?Stage.SCROLL.TOP:Stage.SCROLL.BOTTOM}};
Stage.prototype.toBossMode=function(){this.phase=Stage.PHASE.BOSS;this.boss&&AudioMixer.INSTANCE.play(this.boss,.7,!0)};Stage.prototype.draw=function(a){};Stage.createViewList=function(a){var b=[];Stage.VIEWS.forEach(function(c){var d=a[c];if(d&&0!=d.length){var e=a[c+"speed"],g=a[c+"dir"],f=a[c+"blink"];d=c.startsWith("b")?new StageBg(d,e,g,f):new StageFg(d,e,g,f);d.viewId=c;b.push(d)}});return b};
Stage.prototype.init=function(){var a=this;this.map=FieldMap.create(this.map);this.map._stage=this;this.view=[];this.view.forEach(function(b){b.stage=a;a.viewDic[b.viewId]=b});this.scrollSv=this.scroll=this.roll;this.setBgm(this.map.theme,this.map.boss);return this};Stage.create=function(a){return Object.assign(new Stage,a).init()};
$jscomp.global.Object.defineProperties(Stage.prototype,{isMoving:{configurable:!0,enumerable:!0,get:function(){return this.phase==Stage.PHASE.NORMAL}},fg:{configurable:!0,enumerable:!0,get:function(){this.foreground||(this.foreground=this.map._mainVisual);return this.foreground}},width:{configurable:!0,enumerable:!0,get:function(){return this.map._mainVisual.image.width}},height:{configurable:!0,enumerable:!0,get:function(){return this.map._mainVisual.image.height}},isLoop:{configurable:!0,enumerable:!0,
get:function(){return this.scroll==Stage.SCROLL.LOOP}}});Stage.SCROLL={OFF:0,ON:1,LOOP:2,TOP:4,BOTTOM:8};Stage.PHASE={NORMAL:0,BOSS:1};Stage.VIEWS="bg1 bg2 bg3 fg1 fg2 fg3".split(" ");Stage.CHECK_POINT=[{x:0,y:0},{x:660,y:0},{x:1440,y:0}];var StageView=function(a,b,c,d){this.imageId=a;this.speed=b;this.dir=c;this.blink=d;this.pattern=null;this.repeatY=this.repeatX=2};
StageView.prototype.reset=function(a){if(!this.width){var b=this.img;this.width=b.width;this.height=b.height;this.w2=b.width*this.repeatX;this.h2=b.height*this.repeatY}this.x=a.x%this.width;this.effectV=this.effectH=this.y=0;this.alpha=1;this.blinkDir=-1};
StageView.prototype.forward=function(){var a=this.stage.effectV;this.effectH=Math.cos(this.dir)*this.speed;this.effectV=Math.sin(this.dir)*this.speed;this.x+=this.effectH;this.y+=this.effectV;this.y-=a*this.speed;this.width<this.x&&(this.x-=this.width);0>this.y&&(this.y+=this.height);this.height<this.y&&(this.y-=this.height)};StageView.prototype.getPattern=function(a){this.pattern||(this.pattern=a.createPattern(this.img,"repeat"));return this.pattern};
StageView.prototype.draw=function(a){this.blink&&(this.alpha+=this.blinkDir*this.blink,.3>=this.alpha||1<=this.alpha)&&(this.blinkDir*=-1);a.save();a.globalAlpha=this.alpha;a.translate(-this.x,-this.y);a.beginPath();a.fillStyle=this.getPattern(a);a.rect(0,0,this.w2,this.h2);a.fill();a.restore()};$jscomp.global.Object.defineProperties(StageView.prototype,{img:{configurable:!0,enumerable:!0,get:function(){return VisualManager.Instance.dic[this.imageId]}}});
var StageFg=function(a,b,c,d){StageView.call(this,a,void 0===b?.5:b,void 0===c?0:c,void 0===d?0:d);this.repeatX=1};$jscomp.inherits(StageFg,StageView);StageFg.prototype.createCanvas=function(){var a=document.createElement("canvas"),b=a.getContext("2d");a.width=this.width;a.height=this.height;b.clearRect(0,0,this.width,this.height);b.drawImage(this.img,0,0);return a};
StageFg.prototype.reset=function(a){StageView.prototype.reset.call(this,a);0==a.x&&(this.x=-this.product.width);this.canvas=this.createCanvas();this.pattern=canvas.getContext("2d").createPattern(this.canvas,"repeat")};var StageBg=function(a,b,c,d){StageView.call(this,a,void 0===b?.5:b,void 0===c?0:c,void 0===d?0:d)};$jscomp.inherits(StageBg,StageView);var VisualManager=function(){Repository.call(this)};$jscomp.inherits(VisualManager,Repository);
VisualManager.prototype.makeName=function(a){return"/visual/src/"+a};VisualManager.prototype.load=function(a,b,c){var d=this;if(c.startsWith("image")){var e=new Image;this.max++;e.onload=function(){d.onload(a,b,e)};e.src=this.makeName(a)}else Repository.prototype.load.call(this,a,b,c)};VisualManager.Instance=new VisualManager;
